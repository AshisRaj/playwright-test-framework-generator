import { expect, test } from '@fixtures';
import { APIResponse } from '@playwright/test';

let contactId: number;

test('Create contact', { tag: ['@smoke', '@regression'] }, async ({ apiService, apiData }) => {
  let response: APIResponse;

  await test.step('Send create contact request', async () => {
    response = await apiService.post('/contacts', apiData.contacts.newContact);
  });

  await test.step('Verify create contact response', async () => {
    expect(response.status()).toBe(201);
    const body = await response.json();
    contactId = body.id;
  });
});

test(
  'Get contacts by userId',
  { tag: ['@smoke', '@regression'] },
  async ({ apiService, apiData }) => {
    let response: APIResponse;

    await test.step('Fetch contacts for user', async () => {
      response = await apiService.get(`/contacts?userId=${apiData.contacts.userId}`);
    });

    await test.step('Verify contacts list contains the userId', async () => {
      expect(response.status()).toBe(200);
      const contacts = await response.json();
      expect(contacts[0].userId).toBe(apiData.contacts.userId);
    });
  },
);

test('Delete contact', { tag: ['@smoke', '@regression'] }, async ({ apiService }) => {
  let response: APIResponse;

  await test.step('Send delete contact request', async () => {
    response = await apiService.delete(`/contacts/${contactId}`);
  });

  await test.step('Verify delete response', async () => {
    expect(response.status()).toBe(200);
  });
});
