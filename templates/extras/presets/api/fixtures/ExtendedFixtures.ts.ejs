import {
  contactsData,
  profilesData,
  usersData,
} from '@data';
import { Fixtures } from '@fixtures';
import type { TestInfo } from '@playwright/test';
import { expect as baseExpect, test as baseTest } from '@playwright/test';
import { ApiClient, type ApiOptions } from '@services';

export const test = baseTest.extend<Fixtures>({
  // Allow tests to optionally provide API client options via `test.use({ apiServiceOptions: { ... } })`
  apiServiceOptions: async ({}, use: (opts: ApiOptions) => Promise<void>) => {
    await use({});
  },

  // Provide ApiClient wrapper as a fixture that tests can use directly
  apiService: async (
    { apiServiceOptions },
    use: (client: ApiClient) => Promise<void>,
    testInfo: TestInfo,
  ) => {
    const baseURL = apiServiceOptions?.apiBaseURL || process.env.API_BASE_URL || '';
    const options: ApiOptions = {
      apiBaseURL: baseURL,
      apiEndPoint: apiServiceOptions?.apiEndPoint || '',
      apiHeaders: apiServiceOptions?.apiHeaders,
      clientCertificates: apiServiceOptions?.clientCertificates,
      log: apiServiceOptions?.log,
    };
    const client = new ApiClient(options, testInfo);
    await use(client);
    await client.dispose();
  },

  /**
   * API test data fixture
   * - Loads from ./data/api/*.ts (typed import)
   * - Available as `{ apiData }` in all tests
   */
  apiData: async ({}, use) => {
    await use({
      contacts: contactsData,
      users: usersData,
      profiles: profilesData,
    });
  },
});

export const expect = baseExpect;
